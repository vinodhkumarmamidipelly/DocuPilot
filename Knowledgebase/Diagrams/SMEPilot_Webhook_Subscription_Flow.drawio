<mxfile host="app.diagrams.net" modified="2024-01-01T00:00:00.000Z" agent="5.0" version="21.0.0" etag="webhook-flow" type="device">
  <diagram name="SMEPilot Webhook Subscription Flow" id="webhook-flow">
    <mxGraphModel dx="1600" dy="1200" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1400" pageHeight="1200" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        
        <!-- Title -->
        <mxCell id="title" value="SMEPilot - Webhook Subscription Flow" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=28;fontStyle=1;fontColor=#1a1a1a" vertex="1" parent="1">
          <mxGeometry x="400" y="20" width="600" height="50" as="geometry" />
        </mxCell>
        
        <!-- Initial Creation -->
        <mxCell id="create-box" value="Webhook Subscription Creation" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#dae8fc;strokeColor=#6c8ebf;strokeWidth=3;fontSize=18;fontStyle=1;align=center;verticalAlign=top;spacingTop=15" vertex="1" parent="1">
          <mxGeometry x="500" y="100" width="400" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="create-step1" value="During Installation:&#xa;SPFx Admin Panel calls Function App endpoint" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff9c4;strokeColor=#f57f17;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="500" y="170" width="400" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="create-step2" value="Function App calls Graph API:&#xa;POST /v1.0/subscriptions&#xa;&#xa;Parameters:&#xa;â€¢ changeType: created,updated&#xa;â€¢ notificationUrl: Function App endpoint&#xa;â€¢ resource: Source Folder (user-selected)&#xa;â€¢ expirationDateTime: +3 days (max)&#xa;â€¢ clientState: Unique identifier" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#6c8ebf;strokeWidth=2;fontSize=11;align=left;verticalAlign=top;spacingLeft=10;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="500" y="250" width="400" height="140" as="geometry" />
        </mxCell>
        
        <mxCell id="create-step3" value="Graph API Returns:&#xa;Subscription ID&#xa;Expiration DateTime" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="500" y="410" width="400" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="create-step4" value="Store Subscription ID&#xa;Save to SMEPilotConfig list&#xa;For automatic renewal" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1bee7;strokeColor=#6a1b9a;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="500" y="490" width="400" height="60" as="geometry" />
        </mxCell>
        
        <!-- Validation -->
        <mxCell id="validation-box" value="Webhook Validation" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff3e0;strokeColor=#e65100;strokeWidth=3;fontSize=18;fontStyle=1;align=center;verticalAlign=top;spacingTop=15" vertex="1" parent="1">
          <mxGeometry x="500" y="570" width="400" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="validation-step1" value="Graph API sends validation request&#xa;to Function App endpoint&#xa;Header: Validation-Token" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#e65100;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="500" y="640" width="400" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="validation-step2" value="Function App validates request&#xa;Extracts Validation-Token from header&#xa;Returns token within 10 seconds" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#e65100;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="500" y="720" width="400" height="70" as="geometry" />
        </mxCell>
        
        <mxCell id="validation-step3" value="âœ… Webhook Subscription Active&#xa;Graph API confirms subscription" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="500" y="810" width="400" height="60" as="geometry" />
        </mxCell>
        
        <!-- Renewal -->
        <mxCell id="renewal-box" value="Automatic Renewal (Every 2 Days)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3f51b5;strokeWidth=3;fontSize=18;fontStyle=1;align=center;verticalAlign=top;spacingTop=15" vertex="1" parent="1">
          <mxGeometry x="500" y="890" width="400" height="50" as="geometry" />
        </mxCell>
        
        <mxCell id="renewal-step1" value="Timer Trigger Function&#xa;Runs every 2 days&#xa;Checks subscription expiration" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#3f51b5;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="500" y="960" width="400" height="60" as="geometry" />
        </mxCell>
        
        <mxCell id="renewal-decision" value="Expires within&#xa;24 hours?" style="rhombus;whiteSpace=wrap;html=1;fillColor=#ffcdd2;strokeColor=#c62828;strokeWidth=2;fontSize=13;fontStyle=1;align=center" vertex="1" parent="1">
          <mxGeometry x="550" y="1040" width="300" height="100" as="geometry" />
        </mxCell>
        
        <mxCell id="renewal-yes" value="Create New Subscription&#xa;Same configuration&#xa;New expiration (+3 days)&#xa;Update Subscription ID in Config" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="50" y="1050" width="300" height="80" as="geometry" />
        </mxCell>
        
        <mxCell id="renewal-no" value="âœ… No Action Needed&#xa;Subscription still valid" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e1d5e7;strokeColor=#9673a6;strokeWidth=2;fontSize=12;align=center;verticalAlign=top;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="1050" y="1050" width="300" height="60" as="geometry" />
        </mxCell>
        
        <!-- Arrows -->
        <mxCell id="arrow1" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#6c8ebf" edge="1" parent="1" source="create-box" target="create-step1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="200" as="sourcePoint" />
            <mxPoint x="750" y="150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow2" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#6c8ebf" edge="1" parent="1" source="create-step1" target="create-step2">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="300" as="sourcePoint" />
            <mxPoint x="750" y="250" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow3" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#82b366" edge="1" parent="1" source="create-step2" target="create-step3">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="500" as="sourcePoint" />
            <mxPoint x="750" y="450" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow4" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#6a1b9a" edge="1" parent="1" source="create-step3" target="create-step4">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="600" as="sourcePoint" />
            <mxPoint x="750" y="550" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow5" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=4;strokeColor=#e65100" edge="1" parent="1" source="create-step4" target="validation-box">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="700" as="sourcePoint" />
            <mxPoint x="750" y="650" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow6" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#e65100" edge="1" parent="1" source="validation-box" target="validation-step1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="800" as="sourcePoint" />
            <mxPoint x="750" y="750" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow7" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#e65100" edge="1" parent="1" source="validation-step1" target="validation-step2">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="900" as="sourcePoint" />
            <mxPoint x="750" y="850" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow8" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#82b366" edge="1" parent="1" source="validation-step2" target="validation-step3">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="1000" as="sourcePoint" />
            <mxPoint x="750" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow9" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=4;strokeColor=#3f51b5" edge="1" parent="1" source="validation-step3" target="renewal-box">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="1100" as="sourcePoint" />
            <mxPoint x="750" y="1050" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow10" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#3f51b5" edge="1" parent="1" source="renewal-box" target="renewal-step1">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="1200" as="sourcePoint" />
            <mxPoint x="750" y="1150" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow11" value="" style="endArrow=classic;html=1;rounded=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;strokeWidth=3;strokeColor=#3f51b5" edge="1" parent="1" source="renewal-step1" target="renewal-decision">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="1300" as="sourcePoint" />
            <mxPoint x="750" y="1250" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow12" value="Yes" style="endArrow=classic;html=1;rounded=0;exitX=0;exitY=0.5;exitDx=0;exitDy=0;entryX=1;entryY=0.5;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#82b366;fontSize=12;fontColor=#2e7d32" edge="1" parent="1" source="renewal-decision" target="renewal-yes">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="1400" as="sourcePoint" />
            <mxPoint x="750" y="1350" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <mxCell id="arrow13" value="No" style="endArrow=classic;html=1;rounded=0;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;strokeWidth=2;strokeColor=#9673a6;fontSize=12;fontColor=#6a1b9a" edge="1" parent="1" source="renewal-decision" target="renewal-no">
          <mxGeometry width="50" height="50" relative="1" as="geometry">
            <mxPoint x="700" y="1400" as="sourcePoint" />
            <mxPoint x="750" y="1350" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        
        <!-- Notes -->
        <mxCell id="note1" value="ðŸ“‹ Key Points:&#xa;â€¢ Webhook expires in 3 days (Graph API limit)&#xa;â€¢ Auto-renewal every 2 days&#xa;â€¢ Validation required within 10 seconds&#xa;â€¢ Subscription ID stored for renewal" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff3e0;strokeColor=#e65100;strokeWidth=2;fontSize=11;align=left;verticalAlign=top;spacingLeft=10;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="50" y="100" width="250" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="note2" value="âš ï¸ Important:&#xa;â€¢ Monitor Source Folder (user-selected)&#xa;â€¢ changeType: created,updated&#xa;â€¢ Function App endpoint must be HTTPS&#xa;â€¢ clientState for deduplication" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffebee;strokeColor=#c62828;strokeWidth=2;fontSize=11;align=left;verticalAlign=top;spacingLeft=10;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="1100" y="100" width="250" height="120" as="geometry" />
        </mxCell>
        
        <mxCell id="note3" value="ðŸ”„ Renewal Process:&#xa;â€¢ Timer runs every 2 days&#xa;â€¢ Checks expiration (24h window)&#xa;â€¢ Creates new subscription&#xa;â€¢ Updates Subscription ID in Config" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#e8eaf6;strokeColor=#3f51b5;strokeWidth=2;fontSize=11;align=left;verticalAlign=top;spacingLeft=10;spacingTop=10" vertex="1" parent="1">
          <mxGeometry x="50" y="1040" width="200" height="100" as="geometry" />
        </mxCell>
        
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>

